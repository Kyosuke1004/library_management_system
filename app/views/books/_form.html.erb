<%= form_with(model: book, local: true) do |f| %>
  <% if book.errors.any? %>
    <div class="notification is-danger mb-4">
      <strong><%= pluralize(book.errors.count, "件のエラー") %>があります:</strong>
      <ul>
        <% book.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <div class="field">
    <label class="label">タイトル</label>
    <div class="control">
      <%= f.text_field :title, class: "input#{' is-danger' if book.errors[:title].any?}" %>
    </div>
    <% if book.errors[:title].any? %>
      <p class="help is-danger"><%= book.errors[:title].first %></p>
    <% end %>
  </div>
  <div class="field mt-2">
    <label class="label">著者</label>
    <div class="no-bulma" style="position: relative;">
      <%= f.text_field :author_names,
        class: "no-bulma tagify--outside input#{' is-danger' if book.errors[:authors].any?}",
        id: "author-input",
        name: "book[author_names]",
        placeholder: "入力して選択またはEnterで追加",
        value: book.authors.map(&:name).join(', ') %>
      <p class="help" style="margin-top: 4px;">
      </p>
    </div>
    <% if book.errors[:authors].any? %>
      <p class="help is-danger"><%= book.errors[:authors].first %></p>
    <% end %>
  </div>
  <div class="field">
    <label class="label">出版社</label>
    <div class="control">
      <%= f.text_field :publisher, class: "input#{' is-danger' if book.errors[:publisher].any?}" %>
    </div>
    <% if book.errors[:publisher].any? %>
      <p class="help is-danger"><%= book.errors[:publisher].first %></p>
    <% end %>
  </div>
  <div class="field">
    <label class="label">出版年</label>
    <div class="control">
      <%= f.text_field :published_year, class: "input#{' is-danger' if book.errors[:published_year].any?}" %>
    </div>
    <% if book.errors[:published_year].any? %>
      <p class="help is-danger"><%= book.errors[:published_year].first %></p>
    <% end %>
  </div>
  <div class="field">
    <label class="label">ISBN</label>
    <div class="control">
      <%= f.text_field :isbn, class: "input#{' is-danger' if book.errors[:isbn].any?}" %>
    </div>
    <% if book.errors[:isbn].any? %>
      <p class="help is-danger"><%= book.errors[:isbn].first %></p>
    <% end %>
  </div>
  <div class="field mt-2">
    <label class="label">タグ</label>
    <div class="no-bulma">
      <%= f.text_field :tag_names,
      class: "no-bulma tagify--outside input",
      id: "tag-input",
      name: "book[tag_names]",
      value: book.tags.map(&:name).join(', '),
      placeholder: "タグを入力してEnterで追加・選択" %>
      <p class="help">既存タグは入力して候補から選択、新規タグは入力後にEnterで追加できます。</p>
    </div>
  </div>
  <div class="field mt-2" data-controller="stock-counter">
    <label class="label">在庫数</label>
    <div class="control" style="display: flex; align-items: center; gap: 8px;">
      <%= button_tag "-", type: :button, class: "button is-small",
          data: { action: "stock-counter#decrement" } %>
      <%= f.number_field :stock_count,
          value: book.book_items.size,
          min: 0,
          class: "input",
          id: "stock-count-input",
          style: "width: 80px; text-align: center;",
          data: { stock_counter_target: "input" } %>
      <%= button_tag "+", type: :button, class: "button is-small",
          data: { action: "stock-counter#increment" } %>
    </div>
  </div>
  <div class="field is-grouped mt-4">
    <div class="control">
      <%= f.submit submit_label, class: "button is-success is-dark" %>
    </div>
    <div class="control">
      <%= link_to "戻る", cancel_path, class: "button is-ghost" %>
    </div>
  </div>
<% end %>
